<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Particle Viewer - Standalone Demo</title>
    
    <!-- Embedded CSS -->
    <style>
        /* Reset & Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: Arial, sans-serif; 
            color: #fff; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%); 
            overflow: hidden; 
            user-select: none;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
        }
        .loading-content { text-align: center; }
        .loading-content h1 { font-size: 2.5rem; margin-bottom: 20px; color: #00ffff; }
        .loading-content p { font-size: 1.1rem; color: #ccc; margin-bottom: 30px; }
        .loading-bar { 
            width: 300px; height: 4px; background: rgba(255,255,255,0.1); 
            border-radius: 2px; overflow: hidden; margin: 0 auto;
        }
        .loading-progress { 
            height: 100%; background: linear-gradient(90deg, #00ff00, #ffff00, #ff0080);
            width: 0%; animation: loadingProgress 2s ease-in-out infinite;
        }
        @keyframes loadingProgress { 0% { width: 0%; } 50% { width: 100%; } 100% { width: 0%; } }

        /* UI Overlay */
        .ui-overlay {
            position: fixed; top: 20px; left: 20px; width: 300px; max-height: calc(100vh - 40px);
            background: rgba(20, 20, 40, 0.95); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 1000; font-size: 14px;
        }
        .panel-header {
            padding: 15px 20px; background: linear-gradient(135deg, #2a2a4a, #3a3a5a);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-header h2 { font-size: 1.2rem; color: #fff; }
        .panel-content { padding: 20px; max-height: calc(100vh - 120px); overflow-y: auto; }

        /* Controls */
        .control-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .control-section h3 { font-size: 1rem; color: #fff; margin-bottom: 15px; }
        button {
            padding: 8px 16px; background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 6px;
            color: #fff; cursor: pointer; font-size: 13px; margin: 2px;
        }
        button:hover { background: rgba(0, 255, 255, 0.3); }

        /* Legend */
        .particle-legend {
            position: fixed; bottom: 20px; right: 20px; width: 200px;
            background: rgba(20, 20, 40, 0.9); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;
            padding: 15px; z-index: 1000;
        }
        .legend-item {
            display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 11px;
        }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        /* Performance Monitor */
        .performance-monitor {
            position: fixed; top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; padding: 10px 15px; font-size: 12px; z-index: 1000;
            display: flex; gap: 15px; font-family: monospace;
        }

        /* Tooltip */
        .particle-tooltip {
            position: fixed; background: rgba(20, 20, 40, 0.95); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 12px;
            font-size: 12px; max-width: 200px; z-index: 2000; pointer-events: none;
            display: none;
        }

        /* Info Panel */
        .particle-info-panel {
            position: fixed; width: 300px; max-height: 400px;
            background: rgba(20, 20, 40, 0.95); backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
            z-index: 2000; display: none; overflow: hidden;
        }
        .info-header { 
            padding: 15px 20px; background: linear-gradient(135deg, #2a2a4a, #3a3a5a);
            display: flex; justify-content: space-between; align-items: center;
        }
        .info-content { padding: 20px; max-height: 300px; overflow-y: auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { display: flex; flex-direction: column; gap: 2px; }
        .info-item label { color: #aaa; font-size: 11px; text-transform: uppercase; }
        .info-item value { color: #fff; font-size: 13px; font-weight: 500; }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <h1>ATLAS Particle Viewer</h1>
            <p>Loading 3D visualization...</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <!-- Three.js Container -->
    <div id="three-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;"></div>

    <!-- UI Elements -->
    <div class="ui-overlay">
        <div class="panel-header">
            <h2>ATLAS Particle Viewer</h2>
        </div>
        <div class="panel-content">
            <div class="control-section">
                <h3>Demo Event</h3>
                <button onclick="loadSampleEvent()">Load Sample Collision</button>
                <button onclick="resetView()">Reset Camera (R)</button>
                <button onclick="toggleAnimation()">⏸️ Animation</button>
            </div>
            <div class="control-section">
                <h3>Instructions</h3>
                <p style="font-size: 12px; color: #ccc; line-height: 1.4;">
                    • Mouse: Orbit camera<br>
                    • Scroll: Zoom in/out<br>
                    • Click tracks: View details<br>
                    • R: Reset view<br>
                    • Space: Toggle animation
                </p>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="particle-legend">
        <h4 style="margin-bottom: 12px; text-align: center;">Particle Types</h4>
        <div class="legend-item"><div class="legend-color" style="background: #00FF00;"></div><span>e⁻ Electron</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #FF0000;"></div><span>μ Muon</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #FFFF00;"></div><span>γ Photon</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #0080FF;"></div><span>π⁺ Pion+</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #FF8000;"></div><span>K⁺ Kaon+</span></div>
    </div>

    <!-- Performance Monitor -->
    <div class="performance-monitor">
        <div>FPS: <span id="fps-display">60</span></div>
        <div>Particles: <span id="particle-count">0</span></div>
    </div>

    <!-- Tooltip -->
    <div class="particle-tooltip" id="tooltip"></div>

    <!-- Info Panel -->
    <div class="particle-info-panel" id="info-panel">
        <div class="info-header">
            <h3>Particle Information</h3>
            <button onclick="hideInfoPanel()">✕</button>
        </div>
        <div class="info-content" id="info-content"></div>
    </div>

    <!-- Three.js Library -->
    <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.157.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Application Code -->
    <script>
        // Global variables
        let scene, camera, renderer, controls, detector, particleTracks = [];
        let currentEvent = null, isAnimating = false;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();

        // Sample event data (simplified)
        const sampleEventData = {
            event_id: "demo-001",
            vertex: { x: 0, y: 0, z: 0 },
            particles: [
                {
                    id: 1, type: "electron", px: 25.3, py: -8.5, pz: 45.2, E: 52.1, charge: -1,
                    trajectory: [
                        { x: 0, y: 0, z: 0 }, { x: 0.15, y: -0.05, z: 0.27 },
                        { x: 0.35, y: -0.12, z: 0.62 }, { x: 0.58, y: -0.19, z: 1.03 },
                        { x: 0.85, y: -0.28, z: 1.52 }
                    ]
                },
                {
                    id: 2, type: "muon", px: 35.8, py: 12.4, pz: 78.9, E: 87.2, charge: -1,
                    trajectory: [
                        { x: 0, y: 0, z: 0 }, { x: 0.18, y: 0.06, z: 0.40 },
                        { x: 0.41, y: 0.14, z: 0.90 }, { x: 0.68, y: 0.24, z: 1.50 },
                        { x: 0.99, y: 0.34, z: 2.20 }
                    ]
                },
                {
                    id: 3, type: "photon", px: -8.2, py: -15.7, pz: 28.1, E: 33.4, charge: 0,
                    trajectory: [
                        { x: 0, y: 0, z: 0 }, { x: -0.08, y: -0.16, z: 0.28 },
                        { x: -0.19, y: -0.35, z: 0.63 }, { x: -0.32, y: -0.58, z: 1.04 }
                    ]
                }
            ]
        };

        // Particle configuration
        const particleConfig = {
            electron: { color: 0x00FF00, name: 'Electron', symbol: 'e⁻' },
            muon: { color: 0xFF0000, name: 'Muon', symbol: 'μ' },
            photon: { color: 0xFFFF00, name: 'Photon', symbol: 'γ' },
            pion_plus: { color: 0x0080FF, name: 'Pion+', symbol: 'π⁺' },
            kaon_plus: { color: 0xFF8000, name: 'Kaon+', symbol: 'K⁺' }
        };

        // Initialize application
        function init() {
            console.log('Initializing ATLAS Particle Viewer...');

            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 3, 8);

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('three-container').appendChild(renderer.domElement);

            // Create controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Setup lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            // Create detector geometry
            createDetector();

            // Setup event listeners
            setupEventListeners();

            // Start animation loop
            animate();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                loadSampleEvent(); // Load demo event
            }, 2000);
        }

        // Create simplified detector
        function createDetector() {
            detector = new THREE.Group();

            // Beam pipe
            const beamPipeGeo = new THREE.CylinderGeometry(0.05, 0.05, 10, 16);
            const beamPipeMat = new THREE.MeshPhongMaterial({ color: 0x404040, transparent: true, opacity: 0.8 });
            const beamPipe = new THREE.Mesh(beamPipeGeo, beamPipeMat);
            detector.add(beamPipe);

            // Inner tracker
            const trackerGeo = new THREE.CylinderGeometry(1.5, 1.5, 6, 32, 1, true);
            const trackerMat = new THREE.MeshLambertMaterial({ color: 0x4169E1, transparent: true, opacity: 0.2, side: THREE.DoubleSide });
            const tracker = new THREE.Mesh(trackerGeo, trackerMat);
            detector.add(tracker);

            // EM Calorimeter
            const emGeo = new THREE.CylinderGeometry(2.2, 2.2, 6, 32, 1, true);
            const emMat = new THREE.MeshLambertMaterial({ color: 0x32CD32, transparent: true, opacity: 0.25, side: THREE.DoubleSide });
            const em = new THREE.Mesh(emGeo, emMat);
            detector.add(em);

            // Hadronic Calorimeter
            const hadGeo = new THREE.CylinderGeometry(3.5, 3.5, 6, 32, 1, true);
            const hadMat = new THREE.MeshLambertMaterial({ color: 0xFF6347, transparent: true, opacity: 0.2, side: THREE.DoubleSide });
            const had = new THREE.Mesh(hadGeo, hadMat);
            detector.add(had);

            // Primary vertex
            const vertexGeo = new THREE.SphereGeometry(0.02, 16, 16);
            const vertexMat = new THREE.MeshPhongMaterial({ color: 0xFFFFFF, emissive: 0x222222 });
            const vertex = new THREE.Mesh(vertexGeo, vertexMat);
            detector.add(vertex);

            scene.add(detector);
        }

        // Load sample event
        function loadSampleEvent() {
            currentEvent = sampleEventData;
            clearTracks();
            createTracks(currentEvent.particles);
            document.getElementById('particle-count').textContent = currentEvent.particles.length;
            console.log('Sample event loaded:', currentEvent.event_id);
        }

        // Clear existing tracks
        function clearTracks() {
            particleTracks.forEach(track => {
                scene.remove(track);
                if (track.geometry) track.geometry.dispose();
                if (track.material) track.material.dispose();
            });
            particleTracks = [];
        }

        // Create particle tracks
        function createTracks(particles) {
            particles.forEach(particle => {
                const config = particleConfig[particle.type] || { color: 0xCCCCCC };
                
                // Create trajectory points
                const points = particle.trajectory.map(p => new THREE.Vector3(p.x, p.y, p.z));
                
                // Create tube geometry for track
                const curve = new THREE.CatmullRomCurve3(points, false, 'catmullrom', 0.5);
                const tubeGeo = new THREE.TubeGeometry(curve, points.length * 2, 0.02, 8, false);
                const tubeMat = new THREE.MeshLambertMaterial({ 
                    color: config.color, 
                    transparent: true, 
                    opacity: 0.8 
                });
                
                const track = new THREE.Mesh(tubeGeo, tubeMat);
                track.userData = { particle: particle };
                
                // Animation
                track.scale.setScalar(0);
                particleTracks.push(track);
                scene.add(track);
                
                // Animate track appearance
                const delay = Math.random() * 1000;
                setTimeout(() => {
                    if (track.scale) {
                        const startTime = performance.now();
                        function animateTrack() {
                            const elapsed = performance.now() - startTime;
                            const progress = Math.min(elapsed / 1000, 1);
                            const scale = easeOutCubic(progress);
                            track.scale.setScalar(scale);
                            
                            if (progress < 1) {
                                requestAnimationFrame(animateTrack);
                            }
                        }
                        animateTrack();
                    }
                }, delay);
                
                // Direction arrow
                if (points.length > 1) {
                    const direction = new THREE.Vector3().subVectors(points[points.length - 1], points[0]).normalize();
                    const arrowGeo = new THREE.ConeGeometry(0.02, 0.1, 8);
                    const arrowMat = new THREE.MeshLambertMaterial({ color: config.color });
                    const arrow = new THREE.Mesh(arrowGeo, arrowMat);
                    arrow.position.copy(points[points.length - 1]);
                    arrow.lookAt(points[points.length - 1].clone().add(direction));
                    arrow.rotateX(Math.PI / 2);
                    arrow.userData = { particle: particle, isArrow: true };
                    
                    particleTracks.push(arrow);
                    scene.add(arrow);
                }
            });
        }

        // Easing function
        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Window resize
            window.addEventListener('resize', onWindowResize);
            
            // Mouse events
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('click', onClick);
            
            // Keyboard events
            window.addEventListener('keydown', onKeyDown);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(particleTracks);
            
            const tooltip = document.getElementById('tooltip');
            
            if (intersects.length > 0) {
                const particle = intersects[0].object.userData.particle;
                if (particle) {
                    const config = particleConfig[particle.type] || { name: 'Unknown', symbol: '?' };
                    const pt = Math.sqrt(particle.px * particle.px + particle.py * particle.py);
                    
                    tooltip.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">${config.symbol} ${config.name}</div>
                        <div>ID: ${particle.id}</div>
                        <div>Energy: ${particle.E.toFixed(1)} GeV</div>
                        <div>pₜ: ${pt.toFixed(1)} GeV/c</div>
                        <div>Charge: ${particle.charge}</div>
                    `;
                    
                    tooltip.style.left = event.clientX + 10 + 'px';
                    tooltip.style.top = event.clientY + 10 + 'px';
                    tooltip.style.display = 'block';
                    
                    document.body.style.cursor = 'pointer';
                } else {
                    tooltip.style.display = 'none';
                    document.body.style.cursor = 'default';
                }
            } else {
                tooltip.style.display = 'none';
                document.body.style.cursor = 'default';
            }
        }

        function onClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(particleTracks);
            
            if (intersects.length > 0) {
                const particle = intersects[0].object.userData.particle;
                if (particle) {
                    showParticleInfo(particle, event);
                }
            } else {
                hideInfoPanel();
            }
        }

        function showParticleInfo(particle, event) {
            const panel = document.getElementById('info-panel');
            const content = document.getElementById('info-content');
            const config = particleConfig[particle.type] || { name: 'Unknown', symbol: '?' };
            const pt = Math.sqrt(particle.px * particle.px + particle.py * particle.py);
            const momentum = Math.sqrt(particle.px * particle.px + particle.py * particle.py + particle.pz * particle.pz);
            
            content.innerHTML = `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h4>${config.name} (${config.symbol})</h4>
                    <div style="color: #ccc; font-size: 12px;">ID: ${particle.id}</div>
                </div>
                
                <div class="info-section">
                    <h5>Kinematics</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Energy (E)</label>
                            <value>${particle.E.toFixed(3)} GeV</value>
                        </div>
                        <div class="info-item">
                            <label>pₓ</label>
                            <value>${particle.px.toFixed(3)} GeV/c</value>
                        </div>
                        <div class="info-item">
                            <label>pᵧ</label>
                            <value>${particle.py.toFixed(3)} GeV/c</value>
                        </div>
                        <div class="info-item">
                            <label>pᵤ</label>
                            <value>${particle.pz.toFixed(3)} GeV/c</value>
                        </div>
                        <div class="info-item">
                            <label>pₜ</label>
                            <value>${pt.toFixed(3)} GeV/c</value>
                        </div>
                        <div class="info-item">
                            <label>|p|</label>
                            <value>${momentum.toFixed(3)} GeV/c</value>
                        </div>
                    </div>
                </div>
                
                <div class="info-section" style="margin-top: 15px;">
                    <h5>Properties</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Charge</label>
                            <value>${particle.charge} e</value>
                        </div>
                        <div class="info-item">
                            <label>Track Points</label>
                            <value>${particle.trajectory.length}</value>
                        </div>
                    </div>
                </div>
            `;
            
            panel.style.left = Math.min(event.clientX + 20, window.innerWidth - 320) + 'px';
            panel.style.top = Math.min(event.clientY + 20, window.innerHeight - 400) + 'px';
            panel.style.display = 'block';
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyR':
                    resetView();
                    break;
                case 'Space':
                    event.preventDefault();
                    toggleAnimation();
                    break;
            }
        }

        function resetView() {
            camera.position.set(5, 3, 8);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }

        function toggleAnimation() {
            isAnimating = !isAnimating;
            if (isAnimating && currentEvent) {
                loadSampleEvent(); // Restart animation
            }
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            renderer.render(scene, camera);
            
            // Simple FPS counter
            if (Math.random() < 0.1) { // Update occasionally
                document.getElementById('fps-display').textContent = Math.round(1000 / 16.67); // Assume 60fps
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            setTimeout(init, 100);
        });
    </script>
</body>
</html>